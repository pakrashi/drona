<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRONA - AI Tutor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DRONA = () => {
          const [screen, setScreen] = useState('login');
          const [currentUser, setCurrentUser] = useState(null);
          const [messages, setMessages] = useState([]);
          const [inputText, setInputText] = useState('');
          const [isTyping, setIsTyping] = useState(false);
          const [showDashboard, setShowDashboard] = useState(false);
          const [isListening, setIsListening] = useState(false);
          const [stats, setStats] = useState({
            parent: { conversations: 0, topics: {}, connections: [] },
            child: { conversations: 0, topics: {}, connections: [] }
          });
          
          const chatEndRef = useRef(null);
          const recognitionRef = useRef(null);

          useEffect(() => {
            chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          const toggleVoice = () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
              alert('Voice not supported. Use Chrome or Safari.');
              return;
            }

            if (isListening && recognitionRef.current) {
              recognitionRef.current.stop();
              setIsListening(false);
              return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => setIsListening(true);
            recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              setInputText(transcript);
              setIsListening(false);
              setTimeout(() => sendMessageWithText(transcript), 300);
            };
            recognition.onerror = (event) => {
              setIsListening(false);
              if (event.error === 'not-allowed') alert('Allow microphone!');
            };
            recognition.onend = () => setIsListening(false);
            recognitionRef.current = recognition;
            try { recognition.start(); } catch (error) { setIsListening(false); }
          };

          const speakText = (text) => {
            if (currentUser !== 'child') return;
            if ('speechSynthesis' in window) {
              window.speechSynthesis.cancel();
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.rate = 0.85;
              utterance.pitch = 1.2;
              window.speechSynthesis.speak(utterance);
            }
          };

          const selectUser = (user) => {
            setCurrentUser(user);
            setScreen('chat');
            const welcomeMsg = user === 'parent'
              ? "Hello! I'm DRONA. Ready to learn?"
              : "Hi! I'm DRONA! Let's have fun learning!";
            setMessages([{ role: 'assistant', content: welcomeMsg }]);
            if (user === 'child') speakText(welcomeMsg);
          };

          const extractConcepts = (text) => {
            const keywords = ['macroeconomics', 'inflation', 'gdp', 'monetary policy', 'payment systems',
              'banking', 'interest rates', 'economics', 'finance', 'money', 'trade', 'market',
              'numbers', 'counting', 'shapes', 'colors', 'animals', 'science', 'nature', 'sky', 'plants'];
            const found = [];
            const lowerText = text.toLowerCase();
            keywords.forEach(keyword => {
              if (lowerText.includes(keyword)) {
                found.push(keyword.charAt(0).toUpperCase() + keyword.slice(1));
              }
            });
            return [...new Set(found)];
          };

          const findConnections = (concepts) => {
            const allTopics = Object.keys(stats[currentUser]?.topics || {});
            const connections = [];
            const related = {
              'inflation': ['monetary policy', 'interest rates', 'gdp'],
              'gdp': ['economics', 'trade'],
              'payment systems': ['banking', 'finance'],
              'monetary policy': ['interest rates', 'inflation']
            };
            concepts.forEach(concept => {
              const lower = concept.toLowerCase();
              if (related[lower]) {
                related[lower].forEach(rel => {
                  const cap = rel.charAt(0).toUpperCase() + rel.slice(1);
                  if (allTopics.includes(cap)) connections.push(`Relates to ${cap}!`);
                });
              }
            });
            return connections;
          };

          const sendMessageWithText = async (messageText) => {
            if (!messageText?.trim()) return;
            const userMessage = messageText.trim();
            setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
            setIsTyping(true);

            try {
              const systemPrompt = currentUser === 'parent'
                ? "You are DRONA, an expert AI tutor. Explain macroeconomics, payment systems, banking clearly. Keep under 100 words."
                : "You are DRONA for a 5-year-old. Use simple words! Maximum 50 words. Make it fun!";

              // Call Netlify Function instead of direct API
              const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-20250514',
                  max_tokens: currentUser === 'child' ? 150 : 300,
                  messages: [
                    { role: 'user', content: systemPrompt },
                    ...messages.slice(-4),
                    { role: 'user', content: userMessage }
                  ]
                })
              });

              if (!response.ok) throw new Error('Failed to get response');
              const data = await response.json();
              const aiResponse = data.content[0].text;
              
              const concepts = extractConcepts(userMessage + ' ' + aiResponse);
              const connections = findConnections(concepts);

              setMessages(prev => [...prev, { role: 'assistant', content: aiResponse, concepts, connections }]);
              if (currentUser === 'child') setTimeout(() => speakText(aiResponse), 500);

              setStats(prev => {
                const updated = { ...prev };
                updated[currentUser].conversations++;
                concepts.forEach(c => {
                  updated[currentUser].topics[c] = (updated[currentUser].topics[c] || 0) + 1;
                });
                if (connections.length > 0) updated[currentUser].connections.push(...connections);
                return updated;
              });
            } catch (error) {
              setMessages(prev => [...prev, { role: 'assistant', content: 'Sorry, please try again!' }]);
            }
            setIsTyping(false);
          };

          const sendMessage = () => {
            sendMessageWithText(inputText);
            setInputText('');
          };

          const handleKeyPress = (e) => {
            if (e.key === 'Enter' && !isTyping) sendMessage();
          };

          if (screen === 'login') {
            return (
              <div className="min-h-screen flex items-center justify-center p-4" style={{
                background: 'linear-gradient(135deg, #faf3e0 0%, #f0e6d2 100%)'
              }}>
                <div className="text-center">
                  <h1 className="text-6xl font-bold mb-2" style={{
                    fontFamily: 'Georgia, serif', color: '#1a4d2e', textShadow: '2px 2px 0 #f4a259'
                  }}>DRONA</h1>
                  <p className="text-xl italic mb-12" style={{ color: '#718096' }}>Your AI Tutor</p>
                  
                  <div className="flex gap-6 flex-wrap justify-center">
                    <div onClick={() => selectUser('parent')}
                      className="bg-white rounded-2xl p-8 w-64 cursor-pointer hover:-translate-y-1 hover:shadow-2xl"
                      style={{ boxShadow: '0 10px 30px rgba(26, 77, 46, 0.1)' }}>
                      <div className="text-6xl mb-4">ğŸ‘¨â€ğŸ’¼</div>
                      <h2 className="text-2xl font-semibold mb-2" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                        Parent
                      </h2>
                      <p style={{ color: '#718096' }}>Advanced Learning</p>
                    </div>
                    
                    <div onClick={() => selectUser('child')}
                      className="bg-white rounded-2xl p-8 w-64 cursor-pointer hover:-translate-y-1 hover:shadow-2xl"
                      style={{ boxShadow: '0 10px 30px rgba(26, 77, 46, 0.1)' }}>
                      <div className="text-6xl mb-4">ğŸ‘¦</div>
                      <h2 className="text-2xl font-semibold mb-2" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                        Child
                      </h2>
                      <p style={{ color: '#718096' }}>Fun & Simple</p>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          const userStats = stats[currentUser] || { conversations: 0, topics: {}, connections: [] };
          const topicsList = Object.entries(userStats.topics).sort((a, b) => b[1] - a[1]).slice(0, 10);

          return (
            <div className="h-screen flex flex-col" style={{ background: '#faf3e0' }}>
              <div className="bg-white p-4 shadow-md flex justify-between items-center">
                <h1 className="text-2xl font-bold" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                  DRONA
                </h1>
                <button onClick={() => {
                    const newUser = currentUser === 'parent' ? 'child' : 'parent';
                    setCurrentUser(newUser);
                    setMessages([]);
                    const msg = newUser === 'parent' ? "Hello! I'm DRONA. Ready to learn?" : "Hi! I'm DRONA! Let's learn!";
                    setMessages([{ role: 'assistant', content: msg }]);
                    if (newUser === 'child') speakText(msg);
                  }}
                  className="flex items-center gap-2 px-4 py-2 rounded-lg text-white hover:scale-105"
                  style={{ background: '#4f772d' }}>
                  <span>{currentUser === 'parent' ? 'ğŸ‘¨â€ğŸ’¼ Parent' : 'ğŸ‘¦ Child'}</span>
                  <span className="text-lg">â‡„</span>
                </button>
              </div>

              <div className="flex-1 overflow-y-auto p-6 space-y-4">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl`}
                      style={{ 
                        background: msg.role === 'assistant' ? 'linear-gradient(135deg, #1a4d2e, #4f772d)' : '#f4a259',
                        color: 'white'
                      }}>
                      {msg.role === 'assistant' ? 'ğŸ“' : (currentUser === 'parent' ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¦')}
                    </div>
                    <div className="max-w-3xl rounded-2xl p-4 shadow-md"
                      style={{ 
                        background: msg.role === 'user' ? '#4f772d' : 'white',
                        color: msg.role === 'user' ? 'white' : '#2d3748'
                      }}>
                      <p className="leading-relaxed">{msg.content}</p>
                      {msg.concepts?.length > 0 && (
                        <div className="flex flex-wrap gap-2 mt-3">
                          {msg.concepts.map((concept, i) => (
                            <span key={i} className="px-3 py-1 rounded-full text-xs font-medium"
                              style={{ background: '#faf3e0', color: '#4f772d' }}>{concept}</span>
                          ))}
                        </div>
                      )}
                      {msg.connections?.length > 0 && (
                        <div className="mt-3 p-3 rounded-lg text-sm" style={{ 
                          background: 'rgba(79, 119, 45, 0.1)', borderLeft: '4px solid #f4a259'
                        }}>
                          <strong>ğŸ”— Connections:</strong>
                          {msg.connections.map((conn, i) => (<div key={i}>â†’ {conn}</div>))}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                
                {isTyping && (
                  <div className="flex gap-3">
                    <div className="w-10 h-10 rounded-full flex items-center justify-center text-xl"
                      style={{ background: 'linear-gradient(135deg, #1a4d2e, #4f772d)', color: 'white' }}>ğŸ“</div>
                    <div className="bg-white rounded-2xl p-4">
                      <div className="flex gap-1">
                        {[0, 1, 2].map(i => (
                          <div key={i} className="w-2 h-2 rounded-full bg-green-700 animate-bounce"
                            style={{ animationDelay: `${i * 0.15}s` }} />
                        ))}
                      </div>
                    </div>
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              <div className="bg-white p-4 shadow-lg">
                <div className="flex gap-3 max-w-4xl mx-auto">
                  <button onClick={toggleVoice}
                    className="w-14 h-14 rounded-full flex items-center justify-center text-white text-2xl hover:scale-110"
                    style={{ background: isListening ? '#e63946' : '#f4a259', animation: isListening ? 'pulse 1.5s infinite' : 'none' }}>
                    ğŸ¤
                  </button>
                  <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder={isListening ? "Listening..." : (currentUser === 'child' ? 'Click ğŸ¤!' : 'Type...')}
                    className="flex-1 px-6 py-3 rounded-full border-2 focus:outline-none focus:border-green-600"
                    style={{ background: '#faf3e0', borderColor: '#4f772d33' }} />
                  <button onClick={sendMessage} disabled={!inputText.trim() || isTyping}
                    className="w-14 h-14 rounded-full flex items-center justify-center text-white text-xl hover:scale-110 disabled:opacity-50"
                    style={{ background: '#4f772d' }}>ğŸ“¤</button>
                </div>
                {isListening && (
                  <div className="text-center mt-3 font-bold animate-pulse" style={{ color: '#e63946' }}>
                    ğŸ™ï¸ Listening... Speak now!
                  </div>
                )}
              </div>

              <button onClick={() => setShowDashboard(!showDashboard)}
                className="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-110"
                style={{ background: '#1a4d2e', color: 'white', zIndex: 50 }}>ğŸ“Š</button>

              {showDashboard && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-end" style={{ zIndex: 100 }}
                  onClick={() => setShowDashboard(false)}>
                  <div className="bg-white w-96 h-full overflow-y-auto p-6" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between mb-6">
                      <h2 className="text-2xl font-bold" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>Dashboard</h2>
                      <button onClick={() => setShowDashboard(false)} className="text-2xl">âœ•</button>
                    </div>
                    <div className="space-y-4">
                      <div className="p-4 rounded-xl" style={{ background: '#faf3e0', borderLeft: '4px solid #4f772d' }}>
                        <div style={{ color: '#718096' }}>Conversations</div>
                        <div className="text-3xl font-bold" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                          {userStats.conversations}
                        </div>
                      </div>
                      <div className="p-4 rounded-xl" style={{ background: '#faf3e0', borderLeft: '4px solid #4f772d' }}>
                        <div style={{ color: '#718096' }}>Topics</div>
                        <div className="text-3xl font-bold" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                          {Object.keys(userStats.topics).length}
                        </div>
                      </div>
                      <div className="p-4 rounded-xl" style={{ background: '#faf3e0', borderLeft: '4px solid #4f772d' }}>
                        <div style={{ color: '#718096' }}>Connections</div>
                        <div className="text-3xl font-bold" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>
                          {userStats.connections.length}
                        </div>
                      </div>
                      {topicsList.length > 0 && (
                        <div>
                          <h3 className="font-bold mb-3" style={{ fontFamily: 'Georgia, serif', color: '#1a4d2e' }}>Topics</h3>
                          {topicsList.map(([topic, count]) => (
                            <div key={topic} className="flex justify-between p-3 bg-white rounded-lg mb-2">
                              <span style={{ color: '#1a4d2e', fontWeight: 500 }}>{topic}</span>
                              <span className="px-3 py-1 rounded-full text-sm text-white" style={{ background: '#4f772d' }}>
                                {count}
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              <style>{`@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }`}</style>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DRONA />);
    </script>
</body>
</html>
